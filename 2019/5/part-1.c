#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <unistd.h>

int mem[] = {

	3,225,1,225,6,6,1100,1,238,225,
	104,0,1101,86,8,225,1101,82,69,225,
	101,36,65,224,1001,224,-106,224,4,224,
	1002,223,8,223,1001,224,5,224,1,223,
	224,223,102,52,148,224,101,-1144,224,224,
	4,224,1002,223,8,223,101,1,224,224,
	1,224,223,223,1102,70,45,225,1002,143,
	48,224,1001,224,-1344,224,4,224,102,8,
	223,223,101,7,224,224,1,223,224,223,
	1101,69,75,225,1001,18,85,224,1001,224,
	-154,224,4,224,102,8,223,223,101,2,
	224,224,1,224,223,223,1101,15,59,225,
	1102,67,42,224,101,-2814,224,224,4,224,
	1002,223,8,223,101,3,224,224,1,223,
	224,223,1101,28,63,225,1101,45,22,225,
	1101,90,16,225,2,152,92,224,1001,224,
	-1200,224,4,224,102,8,223,223,101,7,
	224,224,1,223,224,223,1101,45,28,224,
	1001,224,-73,224,4,224,1002,223,8,223,
	101,7,224,224,1,224,223,223,1,14,
	118,224,101,-67,224,224,4,224,1002,223,
	8,223,1001,224,2,224,1,223,224,223,
	4,223,99,0,0,0,677,0,0,0,
	0,0,0,0,0,0,0,0,1105,0,
	99999,1105,227,247,1105,1,99999,1005,227,99999,
	1005,0,256,1105,1,99999,1106,227,99999,1106,
	0,265,1105,1,99999,1006,0,99999,1006,227,
	274,1105,1,99999,1105,1,280,1105,1,99999,
	1,225,225,225,1101,294,0,0,105,1,
	0,1105,1,99999,1106,0,300,1105,1,99999,
	1,225,225,225,1101,314,0,0,106,0,
	0,1105,1,99999,7,677,677,224,102,2,
	223,223,1005,224,329,1001,223,1,223,1008,
	226,226,224,1002,223,2,223,1005,224,344,
	1001,223,1,223,1107,677,226,224,1002,223,
	2,223,1006,224,359,1001,223,1,223,107,
	677,677,224,102,2,223,223,1005,224,374,
	101,1,223,223,1108,677,226,224,102,2,
	223,223,1005,224,389,1001,223,1,223,1007,
	677,677,224,1002,223,2,223,1005,224,404,
	101,1,223,223,1008,677,226,224,102,2,
	223,223,1005,224,419,101,1,223,223,1108,
	226,677,224,102,2,223,223,1006,224,434,
	1001,223,1,223,8,677,226,224,1002,223,
	2,223,1005,224,449,101,1,223,223,1008,
	677,677,224,1002,223,2,223,1006,224,464,
	1001,223,1,223,1108,226,226,224,1002,223,
	2,223,1005,224,479,1001,223,1,223,1007,
	226,677,224,102,2,223,223,1005,224,494,
	1001,223,1,223,1007,226,226,224,102,2,
	223,223,1005,224,509,101,1,223,223,107,
	677,226,224,1002,223,2,223,1006,224,524,
	1001,223,1,223,108,677,677,224,102,2,
	223,223,1006,224,539,101,1,223,223,7,
	677,226,224,102,2,223,223,1006,224,554,
	1001,223,1,223,1107,226,677,224,102,2,
	223,223,1005,224,569,101,1,223,223,108,
	677,226,224,1002,223,2,223,1006,224,584,
	101,1,223,223,108,226,226,224,102,2,
	223,223,1006,224,599,1001,223,1,223,1107,
	226,226,224,102,2,223,223,1006,224,614,
	1001,223,1,223,8,226,677,224,102,2,
	223,223,1006,224,629,1001,223,1,223,107,
	226,226,224,102,2,223,223,1005,224,644,
	101,1,223,223,8,226,226,224,102,2,
	223,223,1006,224,659,101,1,223,223,7,
	226,677,224,102,2,223,223,1005,224,674,
	101,1,223,223,4,223,99,226

};

typedef enum opcode {
	add = 1, // r1, r2, r3
	mul = 2, // r1, r2, r3
	get = 3,
	put = 4,
	jeq = 5, // jump if true
	jnq = 6, // jump if false
	lt = 7,  // less than
	eq = 8,  // equal
	halt = 99, //
} opcode;

typedef enum param_mode {
	pos = 0, // position in memmory
	dir = 1, // direct value
} param_mode;

int instr_width [halt + 1] = {
	[add] = 4,
	[mul] = 4,
	[get] = 2,
	[put] = 2,
	[jeq] = 3,
	[jnq] = 3,
	[lt]  = 4,
	[eq]  = 4,
	[halt] = 1,
};

typedef struct instr {
	opcode op;
	int r1, r2, r3;
} instr;

#define PARAM_1(in)  (((in->op) / 100  ) % 10)
#define PARAM_2(in)  (((in->op) / 1000 ) % 10)
#define PARAM_3(in)  (((in->op) / 10000) % 10)
#define GET_INSTR(in) ((in->op) % 100)

// #define debug

int run_asm () {
	int* pc = mem;
	instr* in = (instr*) pc;

	int *v1, *v2, *v3;

	do {
		/* Fetch next instruction */
		in = (instr*) pc;

#ifdef debug
		printf("= %li %i, ", pc - mem, in->op);
#endif

		/* Handle adressing modes */
		switch (GET_INSTR(in)) {
			case add:
			case mul:
			case lt:
			case eq:
				switch (PARAM_3(in)) {
					case pos: v3 = &mem[in->r3]; break;
					case dir: v3 = &in->r3; break;
				}
#ifdef debug
				printf("v3 = %i ", *v3);
#endif

			/* fallthrough */
			case jeq:
			case jnq:
				switch (PARAM_2(in)) {
					case pos: v2 = &mem[in->r2]; break;
					case dir: v2 = &in->r2; break;
				}

#ifdef debug
				printf("v2 = %i ", *v2);
#endif

			/* fallthrough */
			case get:
			case put:
				switch (PARAM_1(in)) {
					case pos: v1 = &mem[in->r1]; break;
					case dir: v1 = &in->r1; break;
				}

#ifdef debug
				printf("v1 = %i", *v1);
#endif

			/* fallthrough */
			default: ;
#ifdef debug
				printf("\n");
#endif
		}

		/* Do operation */
		switch (GET_INSTR(in)) {
			case add: *v3 = *v1 + *v2; break;
			case mul: *v3 = *v1 * *v2; break;
			case get:
					  if (isatty(fileno(stdin))) printf("> ");
					  scanf("%i", v1);
					  break;
			case put: printf("%i - ", *v1); break;
			case jeq:
				  if (*v1 != 0) {
					  pc = mem;
					  pc += *v2;
					  continue;
				  } else break;
			case jnq:
				  if (*v1 == 0) {
					  pc = mem;
					  pc += *v2;
					  continue;
				  } else break;

			case lt: *v3 = *v1 < *v2; break;
			case eq: *v3 = *v1 == *v2; break;
			case halt: return mem[0];
		}

		/* Move PC */
		pc += instr_width [GET_INSTR(in)];

	} while (GET_INSTR(in) != halt);

	return mem[0];
}

int main () {
	run_asm ();

	printf("\n");

	return 1;
}
